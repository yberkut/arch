# Підготовка дискових пристроїв

## 1. Створення флешки з ключем та LUKS-заголовком

### **Очищення флешки перед розміткою**

Перед тим як працювати з `parted`, рекомендується повністю очистити флешку від залишків старих файлових систем і метаданих:

```bash
# Визначимо пристрій флешки
lsblk

# Видаляємо всі сигнатури файлових систем (припустимо, що флешка /dev/sdb)
wipefs --all /dev/sdb

# Записуємо нулі в перші мегабайти флешки для додаткової очистки
dd if=/dev/zero of=/dev/sdb bs=1M count=10 status=progress
```

### **Розмітка флешки**

Флешка міститиме два розділи:

- **EFI** (для завантаження GRUB або іншого завантажувача).
- **LUKS-контейнер** (у ньому зберігатиметься ключ `lukskey` та LUKS-заголовок `header.img`).

```bash
# Розмітимо флешку
parted /dev/sdb -- mklabel gpt
parted /dev/sdb -- mkpart ESP fat32 1MiB 1024MiB
parted /dev/sdb -- set 1 esp on
parted /dev/sdb -- mkpart luks_part 1024MiB 100%

# Форматуємо EFI-розділ
mkfs.fat -F32 /dev/sdb1

# Створюємо LUKS-контейнер для ключа
cryptsetup luksFormat /dev/sdb2

# Відкриваємо LUKS-контейнер
cryptsetup open /dev/sdb2 lukskey_container

# Створюємо файлову систему в контейнері
mkfs.ext4 /dev/mapper/lukskey_container

# Монтуємо
mount /dev/mapper/lukskey_container /mnt
```

### **Генерація ключа та заголовка**

```bash
# Генеруємо файл з ключем (256 байтів)
dd if=/dev/random of=/mnt/lukskey bs=256 count=1
chmod 600 /mnt/lukskey

# Створюємо порожній файл для заголовка (16МБ)
truncate -s 16M /mnt/header.img
```

## 2. Підготовка основного диска

Основний диск буде повністю зашифрований LUKS, а заголовок зберігатиметься **тільки на флешці**.

```bash
# Створюємо LUKS-контейнер без заголовка на диску, використовуючи ключ із флешки
cryptsetup --key-file=/mnt/lukskey --keyfile-size=256 \
  luksFormat /dev/sda --header /mnt/header.img

# Відкриваємо зашифрований диск (з використанням заголовка з флешки)
cryptsetup open --header /mnt/header.img --key-file=/mnt/lukskey \
  --keyfile-size=256 /dev/sda enc
```

**Пояснення параметрів:**

- `--keyfile-size=256` – ключ займає 256 байтів у файлі `lukskey`.

Якщо файл містить кілька ключів, потрібно вказувати унікальні значення `offset` для кожного ключа, щоб вони не перетиналися.

### **Навіщо суфікс ************`.img`************ у ************`header.img`************?**

Суфікс `.img` використовується для наочності, щоб позначити, що це образ (image) LUKS-заголовка. Це не обов’язкова вимога, але допомагає відрізняти його від інших файлів.

## 3. Завершення

```bash
# Закриваємо доступ до флешки
cryptsetup close lukskey_container
umount /mnt
```

На цьому етапі у нас є:

- Флешка з LUKS-контейнером, що містить `lukskey` та `header.img`.
- Основний диск, зашифрований LUKS, без заголовка на ньому.

В подальшому для розшифрування основного диска потрібна флешка! Без неї доступу до даних не буде.

