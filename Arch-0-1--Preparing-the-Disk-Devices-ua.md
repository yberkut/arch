# Підготовка дискових пристроїв

## 1. Створення флешки з ключем та LUKS-заголовком

### **Розмітка флешки**

Флешка міститиме два розділи:

- **EFI** (для завантаження GRUB або іншого завантажувача).
- **LUKS-контейнер** (у ньому зберігатиметься ключ `lukskey` та LUKS-заголовок `header.img`).

```bash
# Визначимо пристрій флешки
lsblk

# Розмітимо флешку (припустимо, що це /dev/sdb)
parted /dev/sdb -- mklabel gpt
parted /dev/sdb -- mkpart ESP fat32 1MiB 1024MiB
parted /dev/sdb -- set 1 esp on
parted /dev/sdb -- mkpart luks_part 1024MiB 100%

# Форматуємо EFI-розділ
mkfs.fat -F32 /dev/sdb1

# Створюємо LUKS-контейнер для ключа
cryptsetup luksFormat /dev/sdb2

# Відкриваємо LUKS-контейнер
cryptsetup open /dev/sdb2 lukskey_container

# Створюємо файлову систему в контейнері
mkfs.ext4 /dev/mapper/lukskey_container

# Монтуємо
mount /dev/mapper/lukskey_container /mnt
```

### **Генерація ключа та заголовка**

```bash
# Генеруємо ключ для розшифрування основного диска
dd if=/dev/random of=/mnt/lukskey bs=256 count=1
chmod 600 /mnt/lukskey

# Створюємо порожній файл для заголовка (16МБ)
truncate -s 16M /mnt/header.img
```

## 2. Підготовка основного диска

Основний диск буде повністю зашифрований LUKS, а заголовок зберігатиметься **тільки на флешці**.

```bash
# Створюємо LUKS-контейнер без заголовка на диску, використовуючи ключ із флешки
cryptsetup --key-file=/mnt/lukskey --keyfile-size=256 \
  luksFormat /dev/sda --header /mnt/header.img

# Відкриваємо зашифрований диск (з використанням заголовка з флешки)
cryptsetup open --header /mnt/header.img --key-file=/mnt/lukskey \
  --keyfile-size=256 /dev/sda enc
```

**Пояснення параметрів:**

- `--keyfile-size=256` – довжина ключа у файлі `lukskey`. Важливо, що весь файл може бути більшим, але для дешифрування буде використано лише 256 байтів із початку файлу.

Якщо на флешці є кілька ключів у великому файлі, можна використовувати `--keyfile-offset`, щоб визначати зміщення ключа всередині файла, уникаючи їхнього перетину.

## 3. Завершення

```bash
# Закриваємо доступ до флешки
cryptsetup close lukskey_container
umount /mnt
```

### **Чому `header.img` має суфікс `.img`?**

Суфікс `.img` використовується для позначення того, що це файл-заголовок LUKS, але він не є обов’язковим. Це загальноприйнята практика для позначення файлів, що містять дампи дискових структур або заголовків. Ви можете назвати цей файл інакше, головне – правильно посилатися на нього в командах.

На цьому етапі у нас є:

- Флешка з LUKS-контейнером, що містить `lukskey` та `header.img`.
- Основний диск, зашифрований LUKS, без заголовка на ньому.

В подальшому для розшифрування основного диска потрібна флешка! Без неї доступу до даних не буде.

